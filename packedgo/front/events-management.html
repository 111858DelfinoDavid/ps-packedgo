<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PackedGo - Gestión de Eventos (Admin)</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --secondary-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --text-dark: #333;
            --border-radius: 15px;
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }

        .navbar-custom {
            background: white;
            box-shadow: var(--shadow);
            padding: 1rem 2rem;
        }

        .navbar-brand {
            font-size: 1.8rem;
            font-weight: 700;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .admin-badge {
            background: var(--secondary-gradient);
            color: white;
            padding: 0.3rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .container-custom {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        .page-header {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: #666;
            font-size: 1rem;
        }

        .tabs-container {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .nav-tabs {
            border-bottom: 2px solid #e0e0e0;
            padding: 0 2rem;
        }

        .nav-tabs .nav-link {
            border: none;
            color: #666;
            font-weight: 600;
            padding: 1rem 2rem;
            transition: all 0.3s ease;
            position: relative;
        }

        .nav-tabs .nav-link:hover {
            color: #667eea;
        }

        .nav-tabs .nav-link.active {
            color: #667eea;
            background: transparent;
        }

        .nav-tabs .nav-link.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary-gradient);
            border-radius: 3px 3px 0 0;
        }

        .tab-content {
            padding: 2rem;
        }

        .btn-primary-custom {
            background: var(--primary-gradient);
            border: none;
            color: white;
            padding: 0.8rem 2rem;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success-custom {
            background: var(--success-gradient);
            border: none;
            color: white;
            padding: 0.6rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
        }

        .btn-danger-custom {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            border: none;
            color: white;
            padding: 0.6rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
        }

        .form-control-custom {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }

        .form-control-custom:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.1);
        }

        .form-label-custom {
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 0.5rem;
        }

        .card-custom {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
        }

        .card-custom:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
        }

        .table-custom {
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .table-custom thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .table-custom thead th {
            border: none;
            padding: 1rem;
            font-weight: 600;
        }

        .table-custom tbody td {
            padding: 1rem;
            vertical-align: middle;
            border-bottom: 1px solid #f0f0f0;
        }

        .badge-status {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .badge-active {
            background: #d4edda;
            color: #155724;
        }

        .badge-inactive {
            background: #f8d7da;
            color: #721c24;
        }

        .modal-custom .modal-content {
            border-radius: var(--border-radius);
            border: none;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-custom .modal-header {
            background: var(--primary-gradient);
            color: white;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            padding: 1.5rem 2rem;
        }

        .modal-custom .modal-title {
            font-weight: 700;
        }

        .modal-custom .btn-close {
            filter: brightness(0) invert(1);
        }

        .alert-custom {
            border-radius: 10px;
            border: none;
            padding: 1rem 1.5rem;
            font-weight: 500;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #999;
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .image-preview {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 10px;
            margin-top: 1rem;
        }

        .event-image-thumb {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
        }

        .action-buttons .btn {
            margin: 0 0.2rem;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-custom navbar-expand-lg navbar-light">
        <div class="container-fluid">
            <a class="navbar-brand" href="#"><i class="bi bi-box-seam"></i> PackedGo</a>
            <div class="d-flex align-items-center">
                <span class="admin-badge me-3"><i class="bi bi-shield-check"></i> Administrador</span>
                <button class="btn btn-outline-danger btn-sm" onclick="logout()">
                    <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="container-custom">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title"><i class="bi bi-calendar-event"></i> Gestión de Eventos</h1>
            <p class="page-subtitle">Administra eventos, categorías y consumiciones desde este panel</p>
        </div>

        <!-- Tabs Container -->
        <div class="tabs-container">
            <ul class="nav nav-tabs" id="managementTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="events-tab" data-bs-toggle="tab" data-bs-target="#events" type="button">
                        <i class="bi bi-calendar-event"></i> Eventos
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="event-categories-tab" data-bs-toggle="tab" data-bs-target="#event-categories" type="button">
                        <i class="bi bi-tags"></i> Categorías de Eventos
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="consumptions-tab" data-bs-toggle="tab" data-bs-target="#consumptions" type="button">
                        <i class="bi bi-cup-straw"></i> Consumiciones
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="consumption-categories-tab" data-bs-toggle="tab" data-bs-target="#consumption-categories" type="button">
                        <i class="bi bi-grid-3x3"></i> Categorías de Consumiciones
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="managementTabsContent">
                <!-- EVENTOS TAB -->
                <div class="tab-pane fade show active" id="events" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3><i class="bi bi-calendar-event"></i> Lista de Eventos</h3>
                        <button class="btn btn-primary-custom" onclick="openCreateEventModal()">
                            <i class="bi bi-plus-circle"></i> Crear Nuevo Evento
                        </button>
                    </div>

                    <div id="eventsAlert"></div>

                    <div class="table-responsive">
                        <table class="table table-custom">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Imagen</th>
                                    <th>Nombre</th>
                                    <th>Categoría</th>
                                    <th>Fecha</th>
                                    <th>Capacidad</th>
                                    <th>Precio Base</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="eventsTableBody">
                                <tr>
                                    <td colspan="9" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- CATEGORÍAS DE EVENTOS TAB -->
                <div class="tab-pane fade" id="event-categories" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3><i class="bi bi-tags"></i> Categorías de Eventos</h3>
                        <button class="btn btn-primary-custom" onclick="openCreateEventCategoryModal()">
                            <i class="bi bi-plus-circle"></i> Crear Nueva Categoría
                        </button>
                    </div>

                    <div id="eventCategoriesAlert"></div>

                    <div class="row" id="eventCategoriesContainer">
                        <div class="col-12 text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CONSUMICIONES TAB -->
                <div class="tab-pane fade" id="consumptions" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3><i class="bi bi-cup-straw"></i> Lista de Consumiciones</h3>
                        <button class="btn btn-primary-custom" onclick="openCreateConsumptionModal()">
                            <i class="bi bi-plus-circle"></i> Crear Nueva Consumición
                        </button>
                    </div>

                    <div id="consumptionsAlert"></div>

                    <div class="table-responsive">
                        <table class="table table-custom">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Imagen</th>
                                    <th>Nombre</th>
                                    <th>Categoría</th>
                                    <th>Descripción</th>
                                    <th>Precio</th>
                                    <th>Estado</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="consumptionsTableBody">
                                <tr>
                                    <td colspan="8" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Cargando...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- CATEGORÍAS DE CONSUMICIONES TAB -->
                <div class="tab-pane fade" id="consumption-categories" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h3><i class="bi bi-grid-3x3"></i> Categorías de Consumiciones</h3>
                        <button class="btn btn-primary-custom" onclick="openCreateConsumptionCategoryModal()">
                            <i class="bi bi-plus-circle"></i> Crear Nueva Categoría
                        </button>
                    </div>

                    <div id="consumptionCategoriesAlert"></div>

                    <div class="row" id="consumptionCategoriesContainer">
                        <div class="col-12 text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Cargando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Crear/Editar Evento -->
    <div class="modal fade modal-custom" id="eventModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventModalTitle">
                        <i class="bi bi-calendar-event"></i> Crear Nuevo Evento
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="eventForm">
                        <input type="hidden" id="eventId">
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label-custom">Nombre del Evento</label>
                                <input type="text" class="form-control form-control-custom" id="eventName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label-custom">Categoría</label>
                                <select class="form-select form-control-custom" id="eventCategoryId" required>
                                    <option value="">Seleccione una categoría</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label-custom">Descripción</label>
                            <textarea class="form-control form-control-custom" id="eventDescription" rows="3" required></textarea>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label-custom">Fecha y Hora del Evento</label>
                                <input type="datetime-local" class="form-control form-control-custom" id="eventDate" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label-custom">Precio Base</label>
                                <input type="number" step="0.01" class="form-control form-control-custom" id="eventBasePrice" required>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label-custom">Capacidad Máxima</label>
                                <input type="number" class="form-control form-control-custom" id="eventMaxCapacity" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label-custom">Estado</label>
                                <select class="form-select form-control-custom" id="eventStatus" required>
                                    <option value="SCHEDULED">Programado</option>
                                    <option value="ACTIVE">Activo</option>
                                    <option value="COMPLETED">Completado</option>
                                    <option value="CANCELLED">Cancelado</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label-custom">Latitud</label>
                                <input type="number" step="any" class="form-control form-control-custom" id="eventLat" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label-custom">Longitud</label>
                                <input type="number" step="any" class="form-control form-control-custom" id="eventLng" required>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label-custom">URL de la Imagen</label>
                            <input type="url" class="form-control form-control-custom" id="eventImageUrl" placeholder="https://ejemplo.com/imagen.jpg">
                            <small class="text-muted">Ingrese la URL de la imagen del evento</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success-custom" onclick="saveEvent()">
                        <i class="bi bi-check-circle"></i> Guardar Evento
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Crear/Editar Categoría de Evento -->
    <div class="modal fade modal-custom" id="eventCategoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventCategoryModalTitle">
                        <i class="bi bi-tags"></i> Crear Categoría de Evento
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="eventCategoryForm">
                        <input type="hidden" id="eventCategoryEditId">
                        <div class="mb-3">
                            <label class="form-label-custom">Nombre de la Categoría</label>
                            <input type="text" class="form-control form-control-custom" id="eventCategoryName" required placeholder="Ej: Conciertos, Deportes, Teatro">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success-custom" onclick="saveEventCategory()">
                        <i class="bi bi-check-circle"></i> Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Crear/Editar Consumición -->
    <div class="modal fade modal-custom" id="consumptionModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="consumptionModalTitle">
                        <i class="bi bi-cup-straw"></i> Crear Nueva Consumición
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="consumptionForm">
                        <input type="hidden" id="consumptionId">
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label-custom">Nombre</label>
                                <input type="text" class="form-control form-control-custom" id="consumptionName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label-custom">Categoría</label>
                                <select class="form-select form-control-custom" id="consumptionCategoryId" required>
                                    <option value="">Seleccione una categoría</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label-custom">Descripción</label>
                            <textarea class="form-control form-control-custom" id="consumptionDescription" rows="3" required></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label-custom">Precio</label>
                            <input type="number" step="0.01" class="form-control form-control-custom" id="consumptionPrice" required>
                        </div>

                        <div class="mb-3">
                            <label class="form-label-custom">URL de la Imagen</label>
                            <input type="url" class="form-control form-control-custom" id="consumptionImageUrl" placeholder="https://ejemplo.com/imagen.jpg">
                            <small class="text-muted">Ingrese la URL de la imagen de la consumición</small>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success-custom" onclick="saveConsumption()">
                        <i class="bi bi-check-circle"></i> Guardar Consumición
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Crear/Editar Categoría de Consumición -->
    <div class="modal fade modal-custom" id="consumptionCategoryModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="consumptionCategoryModalTitle">
                        <i class="bi bi-grid-3x3"></i> Crear Categoría de Consumición
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="consumptionCategoryForm">
                        <input type="hidden" id="consumptionCategoryEditId">
                        <div class="mb-3">
                            <label class="form-label-custom">Nombre de la Categoría</label>
                            <input type="text" class="form-control form-control-custom" id="consumptionCategoryName" required placeholder="Ej: Bebidas, Comidas, Snacks">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success-custom" onclick="saveConsumptionCategory()">
                        <i class="bi bi-check-circle"></i> Guardar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ============================================
        // CONFIGURACIÓN Y UTILIDADES
        // ============================================
        const API_BASE_URL = 'http://localhost:8086/api/event-service';
        
        // JWT Utils (copiado de consumer-dashboard)
        const JWTUtils = {
            decodeToken(token) {
                try {
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    return JSON.parse(jsonPayload);
                } catch (error) {
                    console.error('Error decoding token:', error);
                    return null;
                }
            },

            getUserId() {
                const token = localStorage.getItem('userToken');
                if (!token) return null;
                const decoded = this.decodeToken(token);
                return decoded ? decoded.userId : null;
            },

            getRole() {
                const token = localStorage.getItem('userToken');
                if (!token) return null;
                const decoded = this.decodeToken(token);
                return decoded ? decoded.role : null;
            }
        };

        // Verificar que el usuario sea admin
        function checkAdminAccess() {
            const token = localStorage.getItem('userToken');
            
            if (!token) {
                alert('Acceso denegado. Por favor inicie sesión.');
                window.location.href = 'admin-login.html';
                return false;
            }
            
            // Intentar obtener el rol del token JWT
            const roleFromToken = JWTUtils.getRole();
            // Si el token no es un JWT válido, usar el rol almacenado (fallback)
            const storedRole = localStorage.getItem('userRole');
            const effectiveRole = roleFromToken || storedRole;
            
            if (!effectiveRole || (effectiveRole !== 'ADMIN' && effectiveRole !== 'SUPER_ADMIN')) {
                alert('Acceso denegado. Solo administradores pueden acceder a esta página.');
                window.location.href = 'admin-login.html';
                return false;
            }
            
            return true;
        }

        // Mostrar alerta
        function showAlert(message, type, containerId) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show alert-custom" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            document.getElementById(containerId).innerHTML = alertHtml;
            setTimeout(() => {
                const alertElement = document.querySelector(`#${containerId} .alert`);
                if (alertElement) {
                    alertElement.remove();
                }
            }, 5000);
        }

        // Logout
        function logout() {
            localStorage.removeItem('userToken');
            window.location.href = 'admin-login.html';
        }

        // ============================================
        // EVENTOS
        // ============================================
        let currentEventId = null;
        let eventCategories = [];

        async function loadEvents() {
            try {
                const response = await fetch(`${API_BASE_URL}/event`);
                if (!response.ok) throw new Error('Error al cargar eventos');
                
                const events = await response.json();
                renderEvents(events);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('eventsTableBody').innerHTML = `
                    <tr><td colspan="9" class="text-center text-danger">Error al cargar eventos</td></tr>
                `;
            }
        }

        function renderEvents(events) {
            const tbody = document.getElementById('eventsTableBody');
            
            if (events.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9">
                            <div class="empty-state">
                                <i class="bi bi-calendar-x"></i>
                                <p>No hay eventos registrados</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = events.map(event => `
                <tr>
                    <td>${event.id}</td>
                    <td>
                        ${event.imageUrl ? 
                            `<img src="${event.imageUrl}" class="event-image-thumb" alt="${event.name}">` :
                            '<div class="event-image-thumb bg-secondary d-flex align-items-center justify-content-center"><i class="bi bi-image text-white"></i></div>'
                        }
                    </td>
                    <td><strong>${event.name}</strong></td>
                    <td>${event.categoryId || 'N/A'}</td>
                    <td>${new Date(event.eventDate).toLocaleDateString('es-ES', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'})}</td>
                    <td>${event.currentCapacity || 0} / ${event.maxCapacity}</td>
                    <td>$${parseFloat(event.basePrice).toFixed(2)}</td>
                    <td><span class="badge-status ${event.active ? 'badge-active' : 'badge-inactive'}">${event.active ? 'Activo' : 'Inactivo'}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-primary" onclick="editEvent(${event.id})" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteEvent(${event.id})" title="Eliminar">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadEventCategories() {
            try {
                const response = await fetch(`${API_BASE_URL}/category`);
                if (!response.ok) throw new Error('Error al cargar categorías');
                
                eventCategories = await response.json();
                
                // Llenar select del modal
                const select = document.getElementById('eventCategoryId');
                select.innerHTML = '<option value="">Seleccione una categoría</option>' +
                    eventCategories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
                
                // Renderizar cards de categorías
                renderEventCategories(eventCategories);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderEventCategories(categories) {
            const container = document.getElementById('eventCategoriesContainer');
            
            if (categories.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="empty-state">
                            <i class="bi bi-tags"></i>
                            <p>No hay categorías de eventos registradas</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = categories.map(category => `
                <div class="col-md-4 col-lg-3 mb-3">
                    <div class="card-custom text-center">
                        <i class="bi bi-tag-fill" style="font-size: 3rem; color: #667eea;"></i>
                        <h5 class="mt-3 mb-2">${category.name}</h5>
                        <span class="badge-status ${category.active ? 'badge-active' : 'badge-inactive'} mb-3">
                            ${category.active ? 'Activa' : 'Inactiva'}
                        </span>
                        <div class="d-flex justify-content-center gap-2">
                            <button class="btn btn-sm btn-primary" onclick="editEventCategory(${category.id}, '${category.name}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="toggleEventCategoryStatus(${category.id})">
                                <i class="bi bi-toggle-on"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteEventCategory(${category.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openCreateEventModal() {
            currentEventId = null;
            document.getElementById('eventModalTitle').innerHTML = '<i class="bi bi-calendar-event"></i> Crear Nuevo Evento';
            document.getElementById('eventForm').reset();
            document.getElementById('eventId').value = '';
            new bootstrap.Modal(document.getElementById('eventModal')).show();
        }

        async function editEvent(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/event/${id}`);
                if (!response.ok) throw new Error('Error al cargar evento');
                
                const event = await response.json();
                currentEventId = id;
                
                document.getElementById('eventModalTitle').innerHTML = '<i class="bi bi-pencil"></i> Editar Evento';
                document.getElementById('eventId').value = event.id;
                document.getElementById('eventName').value = event.name;
                document.getElementById('eventCategoryId').value = event.categoryId;
                document.getElementById('eventDescription').value = event.description;
                document.getElementById('eventDate').value = event.eventDate.substring(0, 16);
                document.getElementById('eventBasePrice').value = event.basePrice;
                document.getElementById('eventMaxCapacity').value = event.maxCapacity;
                document.getElementById('eventStatus').value = event.status;
                document.getElementById('eventLat').value = event.lat;
                document.getElementById('eventLng').value = event.lng;
                document.getElementById('eventImageUrl').value = event.imageUrl || '';
                
                new bootstrap.Modal(document.getElementById('eventModal')).show();
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al cargar los datos del evento', 'danger', 'eventsAlert');
            }
        }

        async function saveEvent() {
            const userId = JWTUtils.getUserId();
            const eventData = {
                categoryId: parseInt(document.getElementById('eventCategoryId').value),
                name: document.getElementById('eventName').value,
                description: document.getElementById('eventDescription').value,
                eventDate: document.getElementById('eventDate').value,
                lat: parseFloat(document.getElementById('eventLat').value),
                lng: parseFloat(document.getElementById('eventLng').value),
                maxCapacity: parseInt(document.getElementById('eventMaxCapacity').value),
                currentCapacity: 0,
                basePrice: parseFloat(document.getElementById('eventBasePrice').value),
                imageUrl: document.getElementById('eventImageUrl').value || null,
                status: document.getElementById('eventStatus').value,
                createdBy: userId,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            try {
                const token = localStorage.getItem('userToken');
                const url = currentEventId ? `${API_BASE_URL}/event/${currentEventId}` : `${API_BASE_URL}/event`;
                const method = currentEventId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(eventData)
                });

                if (!response.ok) throw new Error('Error al guardar evento');

                bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
                showAlert(`Evento ${currentEventId ? 'actualizado' : 'creado'} exitosamente`, 'success', 'eventsAlert');
                loadEvents();
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al guardar el evento', 'danger', 'eventsAlert');
            }
        }

        async function deleteEvent(id) {
            if (!confirm('¿Está seguro de eliminar este evento?')) return;

            try {
                const token = localStorage.getItem('userToken');
                const response = await fetch(`${API_BASE_URL}/event/logical/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Error al eliminar evento');

                showAlert('Evento eliminado exitosamente', 'success', 'eventsAlert');
                loadEvents();
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al eliminar el evento', 'danger', 'eventsAlert');
            }
        }

        // ============================================
        // CATEGORÍAS DE EVENTOS
        // ============================================
        function openCreateEventCategoryModal() {
            document.getElementById('eventCategoryModalTitle').innerHTML = '<i class="bi bi-tags"></i> Crear Categoría de Evento';
            document.getElementById('eventCategoryForm').reset();
            document.getElementById('eventCategoryEditId').value = '';
            new bootstrap.Modal(document.getElementById('eventCategoryModal')).show();
        }

        function editEventCategory(id, name) {
            document.getElementById('eventCategoryModalTitle').innerHTML = '<i class="bi bi-pencil"></i> Editar Categoría';
            document.getElementById('eventCategoryEditId').value = id;
            document.getElementById('eventCategoryName').value = name;
            new bootstrap.Modal(document.getElementById('eventCategoryModal')).show();
        }

        async function saveEventCategory() {
            const id = document.getElementById('eventCategoryEditId').value;
            const data = {
                name: document.getElementById('eventCategoryName').value
            };

            try {
                const token = localStorage.getItem('userToken');
                const url = id ? `${API_BASE_URL}/category/${id}` : `${API_BASE_URL}/category`;
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Error al guardar categoría');

                bootstrap.Modal.getInstance(document.getElementById('eventCategoryModal')).hide();
                showAlert(`Categoría ${id ? 'actualizada' : 'creada'} exitosamente`, 'success', 'eventCategoriesAlert');
                loadEventCategories();
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al guardar la categoría', 'danger', 'eventCategoriesAlert');
            }
        }

        async function toggleEventCategoryStatus(id) {
            try {
                const token = localStorage.getItem('userToken');
                const response = await fetch(`${API_BASE_URL}/category/status/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Error al cambiar estado');

                showAlert('Estado actualizado exitosamente', 'success', 'eventCategoriesAlert');
                loadEventCategories();
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al actualizar el estado', 'danger', 'eventCategoriesAlert');
            }
        }

        async function deleteEventCategory(id) {
            if (!confirm('¿Está seguro de eliminar esta categoría?')) return;

            try {
                const token = localStorage.getItem('userToken');
                const response = await fetch(`${API_BASE_URL}/category/logical/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Error al eliminar categoría');

                showAlert('Categoría eliminada exitosamente', 'success', 'eventCategoriesAlert');
                loadEventCategories();
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al eliminar la categoría', 'danger', 'eventCategoriesAlert');
            }
        }

        // ============================================
        // CONSUMICIONES
        // ============================================
        let currentConsumptionId = null;
        let consumptionCategories = [];

        async function loadConsumptions() {
            try {
                const response = await fetch(`${API_BASE_URL}/consumption`);
                if (!response.ok) throw new Error('Error al cargar consumiciones');
                
                const consumptions = await response.json();
                renderConsumptions(consumptions);
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('consumptionsTableBody').innerHTML = `
                    <tr><td colspan="8" class="text-center text-danger">Error al cargar consumiciones</td></tr>
                `;
            }
        }

        function renderConsumptions(consumptions) {
            const tbody = document.getElementById('consumptionsTableBody');
            
            if (consumptions.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8">
                            <div class="empty-state">
                                <i class="bi bi-cup-straw"></i>
                                <p>No hay consumiciones registradas</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = consumptions.map(consumption => `
                <tr>
                    <td>${consumption.id}</td>
                    <td>
                        ${consumption.imageUrl ? 
                            `<img src="${consumption.imageUrl}" class="event-image-thumb" alt="${consumption.name}">` :
                            '<div class="event-image-thumb bg-secondary d-flex align-items-center justify-content-center"><i class="bi bi-image text-white"></i></div>'
                        }
                    </td>
                    <td><strong>${consumption.name}</strong></td>
                    <td>${consumption.categoryId || 'N/A'}</td>
                    <td>${consumption.description}</td>
                    <td>$${parseFloat(consumption.price).toFixed(2)}</td>
                    <td><span class="badge-status ${consumption.active ? 'badge-active' : 'badge-inactive'}">${consumption.active ? 'Activo' : 'Inactivo'}</span></td>
                    <td class="action-buttons">
                        <button class="btn btn-sm btn-primary" onclick="editConsumption(${consumption.id})" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteConsumption(${consumption.id})" title="Eliminar">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function loadConsumptionCategories() {
            try {
                const response = await fetch(`${API_BASE_URL}/consumption-category`);
                if (!response.ok) throw new Error('Error al cargar categorías');
                
                consumptionCategories = await response.json();
                
                // Llenar select del modal
                const select = document.getElementById('consumptionCategoryId');
                select.innerHTML = '<option value="">Seleccione una categoría</option>' +
                    consumptionCategories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('');
                
                // Renderizar cards de categorías
                renderConsumptionCategories(consumptionCategories);
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function renderConsumptionCategories(categories) {
            const container = document.getElementById('consumptionCategoriesContainer');
            
            if (categories.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="empty-state">
                            <i class="bi bi-grid-3x3"></i>
                            <p>No hay categorías de consumiciones registradas</p>
                        </div>
                    </div>
                `;
                return;
            }

            container.innerHTML = categories.map(category => `
                <div class="col-md-4 col-lg-3 mb-3">
                    <div class="card-custom text-center">
                        <i class="bi bi-grid-fill" style="font-size: 3rem; color: #f5576c;"></i>
                        <h5 class="mt-3 mb-2">${category.name}</h5>
                        <span class="badge-status ${category.active ? 'badge-active' : 'badge-inactive'} mb-3">
                            ${category.active ? 'Activa' : 'Inactiva'}
                        </span>
                        <div class="d-flex justify-content-center gap-2">
                            <button class="btn btn-sm btn-primary" onclick="editConsumptionCategory(${category.id}, '${category.name}')">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="toggleConsumptionCategoryStatus(${category.id})">
                                <i class="bi bi-toggle-on"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="deleteConsumptionCategory(${category.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openCreateConsumptionModal() {
            currentConsumptionId = null;
            document.getElementById('consumptionModalTitle').innerHTML = '<i class="bi bi-cup-straw"></i> Crear Nueva Consumición';
            document.getElementById('consumptionForm').reset();
            document.getElementById('consumptionId').value = '';
            new bootstrap.Modal(document.getElementById('consumptionModal')).show();
        }

        async function editConsumption(id) {
            try {
                const response = await fetch(`${API_BASE_URL}/consumption/${id}`);
                if (!response.ok) throw new Error('Error al cargar consumición');
                
                const consumption = await response.json();
                currentConsumptionId = id;
                
                document.getElementById('consumptionModalTitle').innerHTML = '<i class="bi bi-pencil"></i> Editar Consumición';
                document.getElementById('consumptionId').value = consumption.id;
                document.getElementById('consumptionName').value = consumption.name;
                document.getElementById('consumptionCategoryId').value = consumption.categoryId;
                document.getElementById('consumptionDescription').value = consumption.description;
                document.getElementById('consumptionPrice').value = consumption.price;
                document.getElementById('consumptionImageUrl').value = consumption.imageUrl || '';
                
                new bootstrap.Modal(document.getElementById('consumptionModal')).show();
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al cargar los datos de la consumición', 'danger', 'consumptionsAlert');
            }
        }

        async function saveConsumption() {
            const consumptionData = {
                categoryId: parseInt(document.getElementById('consumptionCategoryId').value),
                name: document.getElementById('consumptionName').value,
                description: document.getElementById('consumptionDescription').value,
                price: parseFloat(document.getElementById('consumptionPrice').value),
                imageUrl: document.getElementById('consumptionImageUrl').value || null,
                active: true,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            try {
                const token = localStorage.getItem('userToken');
                const url = currentConsumptionId ? `${API_BASE_URL}/consumption/${currentConsumptionId}` : `${API_BASE_URL}/consumption`;
                const method = currentConsumptionId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(consumptionData)
                });

                if (!response.ok) throw new Error('Error al guardar consumición');

                bootstrap.Modal.getInstance(document.getElementById('consumptionModal')).hide();
                showAlert(`Consumición ${currentConsumptionId ? 'actualizada' : 'creada'} exitosamente`, 'success', 'consumptionsAlert');
                loadConsumptions();
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al guardar la consumición', 'danger', 'consumptionsAlert');
            }
        }

        async function deleteConsumption(id) {
            if (!confirm('¿Está seguro de eliminar esta consumición?')) return;

            try {
                const token = localStorage.getItem('userToken');
                const response = await fetch(`${API_BASE_URL}/consumption/logical/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Error al eliminar consumición');

                showAlert('Consumición eliminada exitosamente', 'success', 'consumptionsAlert');
                loadConsumptions();
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al eliminar la consumición', 'danger', 'consumptionsAlert');
            }
        }

        // ============================================
        // CATEGORÍAS DE CONSUMICIONES
        // ============================================
        function openCreateConsumptionCategoryModal() {
            document.getElementById('consumptionCategoryModalTitle').innerHTML = '<i class="bi bi-grid-3x3"></i> Crear Categoría de Consumición';
            document.getElementById('consumptionCategoryForm').reset();
            document.getElementById('consumptionCategoryEditId').value = '';
            new bootstrap.Modal(document.getElementById('consumptionCategoryModal')).show();
        }

        function editConsumptionCategory(id, name) {
            document.getElementById('consumptionCategoryModalTitle').innerHTML = '<i class="bi bi-pencil"></i> Editar Categoría';
            document.getElementById('consumptionCategoryEditId').value = id;
            document.getElementById('consumptionCategoryName').value = name;
            new bootstrap.Modal(document.getElementById('consumptionCategoryModal')).show();
        }

        async function saveConsumptionCategory() {
            const id = document.getElementById('consumptionCategoryEditId').value;
            const data = {
                name: document.getElementById('consumptionCategoryName').value
            };

            try {
                const token = localStorage.getItem('userToken');
                const url = id ? `${API_BASE_URL}/consumption-category/${id}` : `${API_BASE_URL}/consumption-category`;
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                if (!response.ok) throw new Error('Error al guardar categoría');

                bootstrap.Modal.getInstance(document.getElementById('consumptionCategoryModal')).hide();
                showAlert(`Categoría ${id ? 'actualizada' : 'creada'} exitosamente`, 'success', 'consumptionCategoriesAlert');
                loadConsumptionCategories();
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al guardar la categoría', 'danger', 'consumptionCategoriesAlert');
            }
        }

        async function toggleConsumptionCategoryStatus(id) {
            try {
                const token = localStorage.getItem('userToken');
                const response = await fetch(`${API_BASE_URL}/consumption-category/status/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Error al cambiar estado');

                showAlert('Estado actualizado exitosamente', 'success', 'consumptionCategoriesAlert');
                loadConsumptionCategories();
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al actualizar el estado', 'danger', 'consumptionCategoriesAlert');
            }
        }

        async function deleteConsumptionCategory(id) {
            if (!confirm('¿Está seguro de eliminar esta categoría?')) return;

            try {
                const token = localStorage.getItem('userToken');
                const response = await fetch(`${API_BASE_URL}/consumption-category/logical/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) throw new Error('Error al eliminar categoría');

                showAlert('Categoría eliminada exitosamente', 'success', 'consumptionCategoriesAlert');
                loadConsumptionCategories();
            } catch (error) {
                console.error('Error:', error);
                showAlert('Error al eliminar la categoría', 'danger', 'consumptionCategoriesAlert');
            }
        }

        // ============================================
        // INICIALIZACIÓN
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Verificar acceso de admin
            if (!checkAdminAccess()) return;

            // Cargar datos iniciales
            loadEvents();
            loadEventCategories();
            loadConsumptions();
            loadConsumptionCategories();

            // Event listeners para tabs
            document.getElementById('events-tab').addEventListener('shown.bs.tab', loadEvents);
            document.getElementById('event-categories-tab').addEventListener('shown.bs.tab', loadEventCategories);
            document.getElementById('consumptions-tab').addEventListener('shown.bs.tab', loadConsumptions);
            document.getElementById('consumption-categories-tab').addEventListener('shown.bs.tab', loadConsumptionCategories);
        });
    </script>
</body>
</html>
