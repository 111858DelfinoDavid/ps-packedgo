<div class="dashboard-container">
  <!-- Navbar -->
  <nav class="navbar">
    <div class="navbar-brand">
      <i class="bi bi-box-seam"></i>
      <span>PackedGo</span>
    </div>
    
    <!-- Tabs Navigation -->
    <div class="navbar-tabs">
      <button 
        class="tab-button" 
        [class.active]="activeTab === 'events'"
        (click)="switchTab('events')">
        <i class="bi bi-calendar-event"></i>
        <span>Eventos</span>
      </button>
      <button 
        class="tab-button" 
        [class.active]="activeTab === 'cart'"
        (click)="switchTab('cart')">
        <i class="bi bi-cart"></i>
        <span>Mi Carrito</span>
        <span class="badge" *ngIf="cartCount > 0">{{ cartCount }}</span>
      </button>
      <button 
        class="tab-button" 
        [class.active]="activeTab === 'tickets'"
        (click)="switchTab('tickets')">
        <i class="bi bi-ticket-perforated"></i>
        <span>Mis Entradas</span>
      </button>
      <button 
        class="tab-button" 
        [class.active]="activeTab === 'profile'"
        (click)="switchTab('profile')">
        <i class="bi bi-person"></i>
        <span>Mi Perfil</span>
      </button>
    </div>

    <div class="navbar-user">
      <div class="user-info">
        <i class="bi bi-person-circle"></i>
        <span>{{ currentUser?.username || 'Usuario' }}</span>
      </div>
      <button class="btn btn-logout" (click)="logout()">
        <i class="bi bi-box-arrow-right"></i>
        Cerrar Sesión
      </button>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="dashboard-content">
    
    <!-- ==================== EVENTS TAB ==================== -->
    <div *ngIf="activeTab === 'events'" class="tab-content">
      <div class="hero-section">
        <h1>¡Bienvenido, {{ currentUser?.username || 'Usuario' }}!</h1>
        <p>Descubre y participa en los mejores eventos</p>
        
        <div class="search-container">
          <div class="search-wrapper">
            <i class="bi bi-search"></i>
            <input 
              type="text" 
              class="form-control search-input" 
              placeholder="Buscar eventos por nombre o descripción..."
              [(ngModel)]="searchTerm"
              (input)="searchEvents()"
            />
          </div>
        </div>
      </div>

      <div *ngIf="isLoadingEvents" class="loading-container">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Cargando...</span>
        </div>
        <p>Cargando eventos...</p>
      </div>

      <div *ngIf="!isLoadingEvents" class="events-section">
        <h2>Eventos Disponibles</h2>
        
        <div *ngIf="events.length === 0" class="no-results">
          <i class="bi bi-calendar-x"></i>
          <h3>No se encontraron eventos</h3>
          <p>Intenta con otros términos de búsqueda</p>
        </div>

        <div class="events-grid" *ngIf="events.length > 0">
          <div 
            *ngFor="let event of events" 
            class="event-card"
            (click)="viewEventDetails(event.id!)"
          >
            <div class="event-image">
              <img [src]="event.imageUrl || 'https://via.placeholder.com/400x250?text=Evento'" [alt]="event.name" />
              <div class="event-badge">
                <i class="bi bi-calendar-event"></i>
                {{ event.eventDate | date: 'dd/MM/yyyy' }}
              </div>
            </div>

            <div class="event-content">
              <h3>{{ event.name }}</h3>
              <p class="event-description">{{ event.description }}</p>
              
              <div class="event-details">
                <div class="detail-item">
                  <i class="bi bi-people"></i>
                  <span>{{ event.availablePasses || event.maxCapacity }} disponibles</span>
                </div>
                <div class="detail-item">
                  <i class="bi bi-currency-dollar"></i>
                  <span>{{ event.basePrice | currency: 'USD':'symbol':'1.2-2' }}</span>
                </div>
              </div>

              <button class="btn btn-view-details">
                Ver Detalles
                <i class="bi bi-arrow-right"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== CART TAB ==================== -->
    <div *ngIf="activeTab === 'cart'" class="tab-content">
      <div class="cart-section">
        <div class="section-header">
          <h2><i class="bi bi-cart me-2"></i>Mi Carrito de Compras</h2>
          <div class="timer-badge" *ngIf="cartItems.length > 0">
            <i class="bi bi-clock"></i>
            Tiempo restante: <strong>{{ getTimerDisplay() }}</strong>
          </div>
        </div>

        <div *ngIf="cartItems.length === 0" class="empty-cart">
          <i class="bi bi-cart-x"></i>
          <h3>Tu carrito está vacío</h3>
          <p>Explora eventos y agrega paquetes a tu carrito</p>
          <button class="btn btn-primary" (click)="switchTab('events')">
            <i class="bi bi-calendar-event me-2"></i>
            Ver Eventos
          </button>
        </div>

        <div *ngIf="cartItems.length > 0" class="cart-content">
          <div class="cart-items">
            <div *ngFor="let item of cartItems; let i = index" class="cart-item-card">
              <div class="item-header">
                <h4>{{ item.eventName }}</h4>
                <button class="btn-remove" (click)="removeFromCart(i)">
                  <i class="bi bi-trash"></i>
                </button>
              </div>
              <div class="item-details">
                <div class="detail-row">
                  <span>Entrada base:</span>
                  <span>{{ item.basePrice | currency: 'USD':'symbol':'1.2-2' }}</span>
                </div>
                <div class="detail-row" *ngFor="let consumption of item.consumptions">
                  <span>{{ consumption.name }} (x{{ consumption.quantity }})</span>
                  <span>{{ consumption.price * consumption.quantity | currency: 'USD':'symbol':'1.2-2' }}</span>
                </div>
                <div class="detail-row total">
                  <strong>Subtotal:</strong>
                  <strong>{{ item.total | currency: 'USD':'symbol':'1.2-2' }}</strong>
                </div>
              </div>
            </div>
          </div>

          <div class="cart-summary">
            <h3>Resumen de Compra</h3>
            <div class="summary-row">
              <span>Total de items:</span>
              <strong>{{ cartCount }}</strong>
            </div>
            <div class="summary-row total">
              <strong>Total a pagar:</strong>
              <strong class="total-amount">{{ cartTotal | currency: 'USD':'symbol':'1.2-2' }}</strong>
            </div>
            
            <button class="btn btn-checkout" (click)="proceedToCheckout()">
              <i class="bi bi-credit-card me-2"></i>
              Proceder al Pago
            </button>
            
            <button class="btn btn-clear" (click)="clearCart()">
              <i class="bi bi-trash me-2"></i>
              Vaciar Carrito
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== TICKETS TAB ==================== -->
    <div *ngIf="activeTab === 'tickets'" class="tab-content">
      <div class="tickets-section">
        <h2><i class="bi bi-ticket-perforated me-2"></i>Mis Entradas</h2>

        <div *ngIf="isLoadingTickets" class="loading-container">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p>Cargando tus entradas...</p>
        </div>

        <div *ngIf="!isLoadingTickets && myTickets.length === 0" class="empty-state">
          <i class="bi bi-ticket-detailed"></i>
          <h3>No tienes entradas aún</h3>
          <p>Explora eventos y compra tu primera entrada</p>
          <button class="btn btn-primary" (click)="switchTab('events')">
            <i class="bi bi-calendar-event me-2"></i>
            Ver Eventos
          </button>
        </div>

        <div *ngIf="!isLoadingTickets && myTickets.length > 0" class="tickets-grid">
          <div *ngFor="let ticket of myTickets" class="ticket-card">
            <div class="ticket-header">
              <h4>{{ ticket.eventName }}</h4>
              <span class="ticket-status" [class]="ticket.status">{{ ticket.status }}</span>
            </div>
            <div class="ticket-qr">
              <img [src]="ticket.qrCode" alt="QR Code" />
            </div>
            <div class="ticket-details">
              <p><strong>Fecha:</strong> {{ ticket.eventDate | date: 'dd/MM/yyyy HH:mm' }}</p>
              <p><strong>Orden:</strong> #{{ ticket.orderId }}</p>
              <p><strong>Consumiciones incluidas:</strong></p>
              <ul>
                <li *ngFor="let consumption of ticket.consumptions">
                  {{ consumption.name }} (x{{ consumption.quantity }})
                </li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== PROFILE TAB ==================== -->
    <div *ngIf="activeTab === 'profile'" class="tab-content">
      <div class="profile-section">
        <div class="section-header">
          <h2><i class="bi bi-person me-2"></i>Mi Perfil</h2>
          <button 
            *ngIf="!isEditingProfile" 
            class="btn btn-edit" 
            (click)="toggleEditProfile()">
            <i class="bi bi-pencil me-2"></i>
            Editar Perfil
          </button>
        </div>

        <div *ngIf="isLoadingProfile" class="loading-container">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <p>Cargando perfil...</p>
        </div>

        <div *ngIf="!isLoadingProfile" class="profile-content">
          <form [formGroup]="profileForm" (ngSubmit)="onSubmitProfile()">
            <div class="row">
              <div class="col-md-6">
                <div class="form-group">
                  <label for="name">
                    <i class="bi bi-person"></i> Nombre *
                  </label>
                  <input 
                    type="text" 
                    class="form-control" 
                    id="name"
                    formControlName="name"
                    [class.is-invalid]="profileForm.get('name')?.invalid && profileForm.get('name')?.touched"
                  />
                  <div class="invalid-feedback" *ngIf="profileForm.get('name')?.errors?.['required']">
                    El nombre es requerido
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-group">
                  <label for="lastName">
                    <i class="bi bi-person"></i> Apellido *
                  </label>
                  <input 
                    type="text" 
                    class="form-control" 
                    id="lastName"
                    formControlName="lastName"
                    [class.is-invalid]="profileForm.get('lastName')?.invalid && profileForm.get('lastName')?.touched"
                  />
                  <div class="invalid-feedback" *ngIf="profileForm.get('lastName')?.errors?.['required']">
                    El apellido es requerido
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-group">
                  <label for="telephone">
                    <i class="bi bi-telephone"></i> Teléfono *
                  </label>
                  <input 
                    type="tel" 
                    class="form-control" 
                    id="telephone"
                    formControlName="telephone"
                    placeholder="1234567890"
                    [class.is-invalid]="profileForm.get('telephone')?.invalid && profileForm.get('telephone')?.touched"
                  />
                  <div class="invalid-feedback" *ngIf="profileForm.get('telephone')?.errors?.['pattern']">
                    Debe ser un número de 10 dígitos
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-group">
                  <label for="gender">
                    <i class="bi bi-gender-ambiguous"></i> Género *
                  </label>
                  <select 
                    class="form-control" 
                    id="gender"
                    formControlName="gender"
                    [class.is-invalid]="profileForm.get('gender')?.invalid && profileForm.get('gender')?.touched"
                  >
                    <option value="">Seleccionar...</option>
                    <option value="MALE">Masculino</option>
                    <option value="FEMALE">Femenino</option>
                    <option value="OTHER">Otro</option>
                  </select>
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-group">
                  <label for="bornDate">
                    <i class="bi bi-calendar"></i> Fecha de Nacimiento *
                  </label>
                  <input 
                    type="date" 
                    class="form-control" 
                    id="bornDate"
                    formControlName="bornDate"
                    [class.is-invalid]="profileForm.get('bornDate')?.invalid && profileForm.get('bornDate')?.touched"
                  />
                </div>
              </div>

              <div class="col-md-6">
                <div class="form-group">
                  <label for="profileImageUrl">
                    <i class="bi bi-image"></i> URL de Imagen de Perfil
                  </label>
                  <input 
                    type="url" 
                    class="form-control" 
                    id="profileImageUrl"
                    formControlName="profileImageUrl"
                    placeholder="https://ejemplo.com/imagen.jpg"
                  />
                </div>
              </div>
            </div>

            <div class="form-actions" *ngIf="isEditingProfile">
              <button type="submit" class="btn btn-save" [disabled]="profileForm.invalid || isLoadingProfile">
                <i class="bi bi-check-lg me-2"></i>
                Guardar Cambios
              </button>
              <button type="button" class="btn btn-cancel" (click)="toggleEditProfile()">
                <i class="bi bi-x-lg me-2"></i>
                Cancelar
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="dashboard-footer">
      <p>&copy; 2025 PackedGo. Todos los derechos reservados.</p>
    </div>
  </div>
</div>
